<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Athlete Training Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
            min-height: 110px;
        }
        .calendar-day:hover .day-number {
             color: #4f46e5;
        }
        .session-slot {
            transition: background-color 0.2s;
            border-radius: 0.375rem;
        }
        .race-day {
            background-color: #c4b5fd; /* violet-300 */
            color: #3730a3; /* violet-900 */
            border-color: #8b5cf6; /* violet-500 */
            font-weight: 700;
        }
        .reschedule-mode .session-slot {
            cursor: copy;
        }
        .reschedule-mode .session-slot:hover {
            background-color: #dcfce7; /* green-100 */
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .gemini-response {
            border-left: 4px solid #10b981;
            padding-left: 1rem;
            margin-top: 1rem;
            background-color: #f0fdf4;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="setup-container" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-[100] flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Welcome! Let's Connect Your Data.</h2>
            <p class="text-gray-600 mb-6">
                This dashboard reads your training plan from a public Google Sheet. Please paste the public URL to your sheet's CSV file below.
                <button id="show-help-btn" class="text-indigo-600 font-semibold underline text-sm ml-1">(How do I do this?)</button>
            </p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="url" id="sheet-url-input" placeholder="Paste your Google Sheet CSV URL here" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3">
                <button id="load-data-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Load Plan</button>
            </div>
             <p id="setup-error" class="text-red-500 mt-4 text-sm hidden"></p>
        </div>
    </div>
    
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[101] hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 relative">
            <button id="close-help-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">How to Get Your Google Sheet URL</h3>
            <div class="text-left space-y-4 text-gray-700">
                <p><strong>Step 1: Format Your Google Sheet</strong><br>Create a sheet with the exact column headers in the first row: <code>date</code>, <code>am</code>, <code>pm</code>, <code>details</code>. Dates must be in <code>YYYY-MM-DD</code> format.</p>
                <p><strong>Step 2: Publish to the Web</strong><br>In Google Sheets, go to <code>File</code> > <code>Share</code> > <code>Publish to web</code>.</p>
                <p><strong>Step 3: Select CSV Format</strong><br>In the "Link" tab, make sure your training sheet is selected. Then, in the dropdown that says "Web page", change it to <code>Comma-separated values (.csv)</code>.</p>
                <p><strong>Step 4: Publish and Copy URL</strong><br>Click the green "Publish" button and confirm. A URL will be generated. Copy this entire URL.</p>
                <p><strong>Step 5: Paste in Dashboard</strong><br>Paste the copied URL into the input box on the dashboard and click "Load Plan". The app will remember your URL for next time.</p>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        <div id="reschedule-banner" class="hidden bg-yellow-200 text-yellow-800 p-3 rounded-lg text-center mb-4 font-semibold">
            Reschedule Mode: Click an AM or PM slot on any day to move the workout. <button id="cancel-reschedule" class="ml-4 font-bold underline">Cancel</button>
        </div>
        
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Hybrid Athlete Dashboard</h1>
            <p class="text-lg text-gray-600 mt-2">Your complete training journey from July to November 2025.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div id="today-workout-panel" class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-1 flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Today's Training</h2>
                <div id="today-content" class="flex-grow">
                    <p class="text-gray-500">Loading today's schedule...</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg lg:col-span-2 relative">
                <button id="toggle-countdown-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 p-1 rounded-full z-10 hidden">
                    <svg id="expand-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                    <svg id="collapse-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                    </svg>
                </button>
                <div id="countdown-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div id="countdown-1-container" class="text-center">
                        <!-- Content will be injected by JS -->
                    </div>
                    <div id="countdown-2-container" class="text-center hidden">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-lg mb-8">
            <div id="controls" class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="prev-month" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 id="month-year" class="text-2xl md:text-3xl font-bold text-center w-48 md:w-56"></h2>
                    <button id="next-month" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
                 <button id="analyze-week-btn" class="bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors">
                    ✨ Analyze Week
                </button>
            </div>
            <div id="calendar" class="grid grid-cols-7 gap-2"></div>
        </div>

        <footer class="text-center p-4 border-t border-gray-200">
             <div class="flex justify-center flex-wrap gap-4">
                <button id="export-plan-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors whitespace-nowrap">
                    📤 Export Plan to CSV
                </button>
                <button id="force-reload-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors whitespace-nowrap">
                    🔄 Reset & Reload from Sheet
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4">Your changes are saved automatically in your browser. Use "Reset" to re-sync from your master Google Sheet.</p>
        </footer>

    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 relative">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 id="modal-date" class="text-3xl font-bold mb-6 text-gray-900"></h3>
            <div id="modal-content" class="space-y-6"></div>
        </div>
    </div>

<script>
let trainingData = [];

document.addEventListener('DOMContentLoaded', function () {
    const setupContainer = document.getElementById('setup-container');
    const appContainer = document.getElementById('app-container');
    const sheetUrlInput = document.getElementById('sheet-url-input');
    const loadDataBtn = document.getElementById('load-data-btn');
    const setupErrorEl = document.getElementById('setup-error');
    const exportPlanBtn = document.getElementById('export-plan-btn');
    const forceReloadBtn = document.getElementById('force-reload-btn');
    
    const helpModal = document.getElementById('help-modal');
    const showHelpBtn = document.getElementById('show-help-btn');
    const closeHelpModalBtn = document.getElementById('close-help-modal');

    const monthYearEl = document.getElementById('month-year');
    const calendarEl = document.getElementById('calendar');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    
    const modal = document.getElementById('modal');
    const closeModalBtn = document.getElementById('close-modal');
    const modalDateEl = document.getElementById('modal-date');
    const modalContentEl = document.getElementById('modal-content');

    const rescheduleBanner = document.getElementById('reschedule-banner');
    const cancelRescheduleBtn = document.getElementById('cancel-reschedule');
    const analyzeWeekBtn = document.getElementById('analyze-week-btn');
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    let currentDate = new Date(today.getFullYear(), today.getMonth(), 1);

    let isRescheduling = false;
    let workoutToReschedule = null; 

    const raceInfo = [
        { name: '10-Mile Race', date: new Date('2025-10-19T00:00:00') },
        { name: 'Half Marathon', date: new Date('2025-11-27T00:00:00') }
    ];

    const toggleCountdownBtn = document.getElementById('toggle-countdown-btn');
    const countdown1Container = document.getElementById('countdown-1-container');
    const countdown2Container = document.getElementById('countdown-2-container');
    const expandIcon = document.getElementById('expand-icon');
    const collapseIcon = document.getElementById('collapse-icon');

    function saveDataToLocal() {
        localStorage.setItem('savedTrainingData', JSON.stringify(trainingData));
    }

    async function fetchData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            parseCSV(csvText);
            saveDataToLocal();
            localStorage.setItem('googleSheetUrl', url);
            setupContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeApp();
        } catch (error) {
            setupErrorEl.textContent = 'Failed to load data. Please check the URL and ensure your sheet is published correctly.';
            setupErrorEl.classList.remove('hidden');
            console.error('Error fetching sheet data:', error);
        }
    }

    function parseCSV(text) {
        const rows = text.split(/\r?\n/);
        const headers = rows[0].split(',').map(h => h.trim());
        const data = [];
        for (let i = 1; i < rows.length; i++) {
            if (rows[i].trim() === '') continue;
            const values = rows[i].split(',');
            const entry = {};
            headers.forEach((header, index) => {
                entry[header] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '(Rest)';
            });
            data.push(entry);
        }
        trainingData = data;
    }
    
    function exportToCSV() {
        const headers = ['date', 'am', 'pm', 'details'];
        let csvContent = headers.join(',') + '\r\n';

        trainingData.sort((a, b) => new Date(a.date) - new Date(b.date));

        trainingData.forEach(row => {
            const values = headers.map(header => {
                let value = row[header] || '';
                if (value.includes(',')) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            });
            csvContent += values.join(',') + '\r\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "updated_training_plan.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function simpleMarkdownToHtml(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\* (.*?)(?=\n\* |$)/g, '<li class="ml-4 list-disc">$1</li>')
            .replace(/\n/g, '<br>');
    }

    async function callGeminiAPI(prompt, button) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Generating...';

        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
                return result.candidates[0].content.parts[0].text;
            } else {
                return "Sorry, I couldn't generate a response. Please try again.";
            }
        } catch (error) {
            console.error('Gemini API Error:', error);
            return `Error: Could not retrieve insights. ${error.message}`;
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    async function getTodaysFocus(button) {
        const todayStr = today.toISOString().split('T')[0];
        const workout = trainingData.find(w => w.date === todayStr);
        if (!workout || (workout.am === '(Rest)' && workout.pm === '(Rest)')) {
            alert("No workouts scheduled for today to analyze.");
            return;
        }

        const prompt = `You are a world-class hybrid athlete coach. For a user with the following workouts today - AM: ${workout.am}, PM: ${workout.pm} - provide a brief, motivational "Today's Focus". Include 1-2 sentences on mindset, 1 nutritional tip, and 1 recovery tip. Keep it concise, use markdown for formatting (bolding and bullet points), and speak directly to the athlete.`;

        const responseText = await callGeminiAPI(prompt, button);
        const htmlResponse = simpleMarkdownToHtml(responseText);

        let responseContainer = document.getElementById('gemini-focus-response');
        if (!responseContainer) {
            responseContainer = document.createElement('div');
            responseContainer.id = 'gemini-focus-response';
            responseContainer.className = 'gemini-response p-4 rounded-lg text-sm';
            document.getElementById('today-content').appendChild(responseContainer);
        }
        responseContainer.innerHTML = htmlResponse;
    }

    async function getWeeklyAnalysis(button) {
        const firstDayOfWeek = new Date(currentDate);
        while (firstDayOfWeek.getDay() !== 0) {
            firstDayOfWeek.setDate(firstDayOfWeek.getDate() - 1);
        }
        
        let weekPlan = '';
        const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        for (let i = 0; i < 7; i++) {
            const day = new Date(firstDayOfWeek);
            day.setDate(day.getDate() + i);
            const dateStr = day.toISOString().split('T')[0];
            const workout = trainingData.find(w => w.date === dateStr) || { am: '(Rest)', pm: '(Rest)'};
            weekPlan += `${weekDays[i]}: AM - ${workout.am}, PM - ${workout.pm}\n`;
        }

        const prompt = `You are an expert athletic training analyst. Here is my training plan for the week of ${firstDayOfWeek.toLocaleDateString()}:\n${weekPlan}\nPlease provide a brief strategic analysis. Identify the peak training day(s), suggest one key recovery strategy for the week, and offer a single sentence of encouragement. Use markdown.`;

        const responseText = await callGeminiAPI(prompt, button);
        
        modalDateEl.textContent = `Analysis for Week of ${firstDayOfWeek.toLocaleDateString()}`;
        modalContentEl.innerHTML = `<div class="text-gray-800">${simpleMarkdownToHtml(responseText)}</div>`;
        modal.classList.remove('hidden');
    }
    
    function getWorkoutIcon(session) {
        if (!session || session === '(Rest)') return '😴';
        if (session.includes('Run')) return '🏃';
        if (session.includes('Strength')) return '🏋️';
        if (session.includes('Basketball')) return '🏀';
        if (session.includes('Game') || session.includes('RACE')) return '🏆';
        if (session.includes('Recovery')) return '🧘';
        return '⚡';
    }

    function renderCalendar() {
        calendarEl.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.className = 'text-center font-bold text-gray-500 text-xs sm:text-sm py-2';
            dayEl.textContent = day;
            calendarEl.appendChild(dayEl);
        });
        
        const firstDayOfMonth = new Date(year, month, 1);
        const startDayOfWeek = firstDayOfMonth.getDay(); 

        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyEl = document.createElement('div');
            emptyEl.className = "border rounded-lg bg-gray-50";
            calendarEl.appendChild(emptyEl);
        }

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            const dayDate = new Date(year, month, i);
            const dateStr = dayDate.toISOString().split('T')[0];
            const workoutData = trainingData.find(d => d.date === dateStr);
            
            dayEl.className = 'calendar-day border p-1 rounded-lg bg-white flex flex-col';
            dayEl.dataset.fulldate = dateStr;
            dayEl.classList.add('cursor-pointer');

             if (dayDate.getTime() === today.getTime()) {
                dayEl.classList.add('border-indigo-500', 'border-2');
            }
            if(workoutData && (workoutData.am.includes('RACE') || workoutData.am.includes('Game'))) {
                dayEl.classList.add('race-day');
            }

            dayEl.innerHTML = `<div class="day-number font-bold text-sm text-right mb-1">${i}</div>`;
            
            const amSession = workoutData ? workoutData.am : '(Rest)';
            const pmSession = workoutData ? workoutData.pm : '(Rest)';

            let sessionHtml = `<div class="flex-grow flex flex-col justify-around text-xs space-y-1 overflow-hidden">`;

            sessionHtml += `<div class="session-slot p-1" data-session="am" data-fulldate="${dateStr}">
                                ${amSession !== '(Rest)' ? `<span class="truncate block">${getWorkoutIcon(amSession)} ${amSession}</span>` : '&nbsp;'}
                           </div>`;
            sessionHtml += `<div class="session-slot p-1" data-session="pm" data-fulldate="${dateStr}">
                                ${pmSession !== '(Rest)' ? `<span class="truncate block">${getWorkoutIcon(pmSession)} ${pmSession}</span>` : '&nbsp;'}
                           </div>`;

            sessionHtml += '</div>';
            dayEl.innerHTML += sessionHtml;
            
            calendarEl.appendChild(dayEl);
        }
    }

    function showModal(dateStr, isEditing = false) {
        let workoutData = trainingData.find(d => d.date === dateStr);
        if (!workoutData) {
            workoutData = { date: dateStr, am: '(Rest)', pm: '(Rest)', details: '' };
        }

        const date = new Date(dateStr + 'T12:00:00');
        modalDateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        if (isEditing) {
            modalContentEl.innerHTML = `
                <div class="space-y-4" data-date="${dateStr}">
                    <div>
                        <label for="edit-am" class="block text-sm font-medium text-gray-700">AM Session</label>
                        <input type="text" id="edit-am" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="${workoutData.am}">
                    </div>
                    <div>
                        <label for="edit-pm" class="block text-sm font-medium text-gray-700">PM Session</label>
                        <input type="text" id="edit-pm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="${workoutData.pm}">
                    </div>
                    <div>
                        <label for="edit-details" class="block text-sm font-medium text-gray-700">Details & Notes</label>
                        <textarea id="edit-details" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">${workoutData.details || ""}</textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button id="cancel-edit-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancel</button>
                        <button id="save-changes-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Save Changes</button>
                    </div>
                </div>
            `;
            document.getElementById('save-changes-btn').onclick = () => saveWorkout(dateStr);
            document.getElementById('cancel-edit-btn').onclick = () => showModal(dateStr, false);
        } else {
             modalContentEl.innerHTML = `
                <div id="view-mode-content" data-date="${dateStr}">
                    <div class="border-l-4 border-indigo-500 pl-4 py-2">
                        <p class="text-sm font-semibold text-gray-500">AM Session</p>
                        <p class="text-xl font-bold text-gray-900">${workoutData.am}</p>
                        <div class="flex gap-2 mt-2">
                            <button data-session="am" class="reschedule-session-btn bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-200" ${workoutData.am === '(Rest)' ? 'disabled' : ''}>Reschedule</button>
                            <button data-session="am" class="cancel-session-btn bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-red-200" ${workoutData.am === '(Rest)' ? 'disabled' : ''}>Cancel</button>
                        </div>
                    </div>
                    <div class="border-l-4 border-teal-500 pl-4 py-2 mt-4">
                        <p class="text-sm font-semibold text-gray-500">PM Session</p>
                        <p class="text-xl font-bold text-gray-900">${workoutData.pm}</p>
                        <div class="flex gap-2 mt-2">
                            <button data-session="pm" class="reschedule-session-btn bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-200" ${workoutData.pm === '(Rest)' ? 'disabled' : ''}>Reschedule</button>
                            <button data-session="pm" class="cancel-session-btn bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-red-200" ${workoutData.pm === '(Rest)' ? 'disabled' : ''}>Cancel</button>
                        </div>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg mt-4">
                        <p class="text-sm font-semibold text-gray-500">Details & Notes</p>
                        <p class="text-lg text-gray-800">${workoutData.details || "No specific details for this day."}</p>
                    </div>
                    <div class="flex flex-wrap justify-end gap-3 pt-6">
                        <button id="edit-day-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Edit Day / Add Note</button>
                    </div>
                </div>
            `;
            document.getElementById('edit-day-btn').onclick = () => showModal(dateStr, true);
            document.querySelectorAll('.cancel-session-btn').forEach(btn => {
                btn.onclick = (e) => cancelSession(dateStr, e.target.dataset.session);
            });
            document.querySelectorAll('.reschedule-session-btn').forEach(btn => {
                btn.onclick = (e) => initiateReschedule(dateStr, e.target.dataset.session);
            });
        }
        modal.classList.remove('hidden');
    }

    function saveWorkout(dateStr) {
        let index = trainingData.findIndex(w => w.date === dateStr);
        const amVal = document.getElementById('edit-am').value.trim();
        const pmVal = document.getElementById('edit-pm').value.trim();
        const detailsVal = document.getElementById('edit-details').value.trim();

        if (index === -1) {
            if (amVal && amVal !== '(Rest)' || pmVal && pmVal !== '(Rest)' || detailsVal) {
                trainingData.push({ 
                    date: dateStr, 
                    am: amVal || '(Rest)', 
                    pm: pmVal || '(Rest)', 
                    details: detailsVal 
                });
            }
        } else {
            trainingData[index].am = amVal || '(Rest)';
            trainingData[index].pm = pmVal || '(Rest)';
            trainingData[index].details = detailsVal;
        
            if (trainingData[index].am === '(Rest)' && trainingData[index].pm === '(Rest)' && !trainingData[index].details) {
                trainingData.splice(index, 1);
            }
        }
        
        saveDataToLocal();
        refreshApp();
        modal.classList.add('hidden');
    }
    
    function cancelSession(dateStr, sessionType) {
        const index = trainingData.findIndex(w => w.date === dateStr);
        if (index > -1) {
            trainingData[index][sessionType] = '(Rest)';
            if (trainingData[index].am === '(Rest)' && trainingData[index].pm === '(Rest)' && !trainingData[index].details) {
                trainingData.splice(index, 1);
            }
            saveDataToLocal();
        }
        modal.classList.add('hidden');
        refreshApp();
    }
    
    function initiateReschedule(dateStr, sessionType) {
        const workoutData = trainingData.find(d => d.date === dateStr);
        if (!workoutData) return;

        workoutToReschedule = { 
            date: dateStr, 
            sessionType: sessionType, 
            activity: workoutData[sessionType],
            details: workoutData.details 
        };
        isRescheduling = true;
        
        modal.classList.add('hidden');
        rescheduleBanner.classList.remove('hidden');
        appContainer.classList.add('reschedule-mode');
    }
    
    function completeReschedule(newDateStr, newSessionType) {
        if(!isRescheduling || !workoutToReschedule) return;

        const originalDayIndex = trainingData.findIndex(d => d.date === workoutToReschedule.date);
        let targetDayIndex = trainingData.findIndex(d => d.date === newDateStr);

        if (targetDayIndex > -1 && trainingData[targetDayIndex][newSessionType] !== '(Rest)') {
            if (!confirm(`The ${newSessionType.toUpperCase()} session on ${new Date(newDateStr + 'T12:00:00').toLocaleDateString()} is already booked. Overwrite it?`)) {
                cancelReschedule();
                return;
            }
        }

        if (originalDayIndex > -1) {
            trainingData[originalDayIndex][workoutToReschedule.sessionType] = '(Rest)';
            if (trainingData[originalDayIndex].am === '(Rest)' && trainingData[originalDayIndex].pm === '(Rest)' && !trainingData[originalDayIndex].details) {
                trainingData.splice(originalDayIndex, 1);
            }
        }

        if (targetDayIndex === -1) {
             trainingData.push({ date: newDateStr, am: '(Rest)', pm: '(Rest)', details: '' });
             targetDayIndex = trainingData.length - 1;
        }

        trainingData[targetDayIndex][newSessionType] = workoutToReschedule.activity;
        
        const detailNote = `(Rescheduled from ${new Date(workoutToReschedule.date  + 'T12:00:00').toLocaleDateString('en-US',{month:'short', day:'numeric'})})`;
        if (!trainingData[targetDayIndex].details || !trainingData[targetDayIndex].details.includes(detailNote)) {
             trainingData[targetDayIndex].details = trainingData[targetDayIndex].details ? `${trainingData[targetDayIndex].details} | ${detailNote}` : detailNote;
        }

        trainingData.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        saveDataToLocal();
        cancelReschedule();
        refreshApp();
    }

    function cancelReschedule() {
        isRescheduling = false;
        workoutToReschedule = null;
        rescheduleBanner.classList.add('hidden');
        appContainer.classList.remove('reschedule-mode');
    }
    
    function updateTodaysWorkout() {
        const todayStr = today.toISOString().split('T')[0];
        const workout = trainingData.find(w => w.date === todayStr);
        const container = document.getElementById('today-content');
        if (workout) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="border-l-4 border-indigo-500 pl-3">
                        <p class="text-sm font-medium text-gray-500">AM</p>
                        <p class="text-lg font-bold">${workout.am}</p>
                    </div>
                     <div class="border-l-4 border-teal-500 pl-3">
                        <p class="text-sm font-medium text-gray-500">PM</p>
                        <p class="text-lg font-bold">${workout.pm}</p>
                    </div>
                    <p class="text-gray-700 pt-2">${workout.details || ""}</p>
                </div>
                <div class="mt-4">
                    <button id="get-focus-btn" class="w-full bg-emerald-100 text-emerald-800 font-bold py-2 px-4 rounded-lg hover:bg-emerald-200 transition-colors">
                        ✨ Today's Focus
                    </button>
                </div>
            `;
            document.getElementById('get-focus-btn').addEventListener('click', (e) => getTodaysFocus(e.target));
        } else {
            container.innerHTML = `<p class="text-gray-600">No training scheduled for today. Enjoy the rest!</p>`;
        }
    }
    
    function updateCountdowns() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const upcomingRaces = raceInfo
            .map(race => ({
                ...race,
                diff: Math.ceil((race.date - today) / (1000 * 60 * 60 * 24))
            }))
            .filter(race => race.diff >= 0)
            .sort((a, b) => a.date - b.date);

        countdown1Container.innerHTML = '';
        countdown2Container.innerHTML = '';
        countdown2Container.classList.add('hidden');
        collapseIcon.classList.add('hidden');
        expandIcon.classList.remove('hidden');
        toggleCountdownBtn.classList.add('hidden');

        if (upcomingRaces.length > 0) {
            const nextRace = upcomingRaces[0];
            countdown1Container.innerHTML = `
                <h3 class="text-md font-semibold text-gray-500">${nextRace.name}</h3>
                <p class="text-3xl font-bold text-indigo-600">${nextRace.diff} Days</p>
                <p class="text-xs text-gray-500">${nextRace.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
            `;
        } else {
            countdown1Container.innerHTML = `
                <h3 class="text-md font-semibold text-gray-500">All Races Complete!</h3>
                <p class="text-3xl font-bold text-green-600">🎉</p>
                <p class="text-xs text-gray-500">Time to plan the next challenge.</p>
            `;
        }

        if (upcomingRaces.length > 1) {
            const secondRace = upcomingRaces[1];
            countdown2Container.innerHTML = `
                <h3 class="text-md font-semibold text-gray-500">${secondRace.name}</h3>
                <p class="text-3xl font-bold text-indigo-600">${secondRace.diff} Days</p>
                <p class="text-xs text-gray-500">${secondRace.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
            `;
            toggleCountdownBtn.classList.remove('hidden');
        }
    }
    
    function refreshApp() {
        renderCalendar();
        updateTodaysWorkout();
    }
    
    function initializeApp() {
        appContainer.classList.remove('hidden');
        setupContainer.classList.add('hidden');
        refreshApp();
        updateCountdowns();
        addEventListeners();
    }
    
    function addEventListeners() {
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        
        calendarEl.addEventListener('click', (e) => {
            const sessionSlot = e.target.closest('.session-slot');
            const dayEl = e.target.closest('.calendar-day');

            if (sessionSlot && isRescheduling) {
                completeReschedule(sessionSlot.dataset.fulldate, sessionSlot.dataset.session);
            } else if (dayEl) {
                showModal(dayEl.dataset.fulldate);
            }
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
        
        cancelRescheduleBtn.addEventListener('click', () => {
            cancelReschedule();
        });
        
        showHelpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        exportPlanBtn.addEventListener('click', exportToCSV);
        forceReloadBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset your plan? This will delete all local changes and reload from your master Google Sheet.')) {
                localStorage.removeItem('savedTrainingData');
                const savedUrl = localStorage.getItem('googleSheetUrl');
                if (savedUrl) {
                    fetchData(savedUrl);
                } else {
                     location.reload();
                }
            }
        });

        toggleCountdownBtn.addEventListener('click', () => {
            countdown2Container.classList.toggle('hidden');
            expandIcon.classList.toggle('hidden');
            collapseIcon.classList.toggle('hidden');
        });

        analyzeWeekBtn.addEventListener('click', (e) => getWeeklyAnalysis(e.target));
    }

    loadDataBtn.addEventListener('click', () => {
        const url = sheetUrlInput.value.trim();
        if (url) {
            setupErrorEl.classList.add('hidden');
            fetchData(url);
        } else {
            setupErrorEl.textContent = 'Please enter a valid URL.';
            setupErrorEl.classList.remove('hidden');
        }
    });

    const savedTrainingData = localStorage.getItem('savedTrainingData');
    if (savedTrainingData) {
        trainingData = JSON.parse(savedTrainingData);
        initializeApp();
    } else {
        const savedUrl = localStorage.getItem('googleSheetUrl');
        if (savedUrl) {
             fetchData(savedUrl);
        } else {
            setupContainer.classList.remove('hidden');
            showHelpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        }
    }
});
</script>
</body>
</html>
